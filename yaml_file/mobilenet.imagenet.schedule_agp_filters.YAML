#
# 0005 --compress=../agp-pruning/resnet50.schedule_agp.filters.yaml
# Parameters:
# +----+--------------------------+--------------------+---------------+----------------+------------+------------+----------+----------+----------+------------+---------+----------+------------+
# |    | Name                     | Shape              |   NNZ (dense) |   NNZ (sparse) |   Cols (%) |   Rows (%) |   Ch (%) |   2D (%) |   3D (%) |   Fine (%) |     Std |     Mean |   Abs-Mean |
# |----+--------------------------+--------------------+---------------+----------------+------------+------------+----------+----------+----------+------------+---------+----------+------------|
# |  0 | module.model.0.0.weight  | (32, 3, 3, 3)      |           864 |            864 |    0.00000 |    0.00000 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.14464 |  0.00108 |    0.06509 |
# |  1 | module.model.1.0.weight  | (32, 1, 3, 3)      |           288 |            288 |    0.00000 |    0.00000 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.32138 |  0.01007 |    0.12923 |
# |  2 | module.model.1.3.weight  | (64, 32, 1, 1)     |          2048 |           2048 |    0.00000 |    0.00000 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.11941 |  0.00027 |    0.03629 |
# |  3 | module.model.2.0.weight  | (64, 1, 3, 3)      |           576 |            576 |    0.00000 |    0.00000 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.15801 |  0.00543 |    0.11486 |
# |  4 | module.model.2.3.weight  | (128, 64, 1, 1)    |          8192 |           8192 |    0.00000 |    0.00000 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.08440 | -0.00034 |    0.04182 |
# |  5 | module.model.3.0.weight  | (128, 1, 3, 3)     |          1152 |           1152 |    0.00000 |    0.00000 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.16780 |  0.00114 |    0.10551 |
# |  6 | module.model.3.3.weight  | (128, 128, 1, 1)   |         16384 |          16384 |    0.00000 |    0.00000 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.07125 | -0.00192 |    0.04127 |
# |  7 | module.model.4.0.weight  | (128, 1, 3, 3)     |          1152 |           1152 |    0.00000 |    0.00000 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.10182 |  0.00172 |    0.08723 |
# |  8 | module.model.4.3.weight  | (256, 128, 1, 1)   |         32768 |          16384 |    0.00000 |    0.00000 | 10.15625 | 50.00000 | 12.50000 |   50.00000 | 0.05606 | -0.00004 |    0.02986 |
# |  9 | module.model.5.0.weight  | (256, 1, 3, 3)     |          2304 |           2304 |    0.00000 |    0.00000 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.12516 | -0.00287 |    0.08047 |
# | 10 | module.model.5.3.weight  | (256, 256, 1, 1)   |         65536 |          32768 |    0.00000 |    0.00000 | 12.50000 | 50.00000 | 23.04688 |   50.00000 | 0.04501 |  0.00002 |    0.02443 |
# | 11 | module.model.6.0.weight  | (256, 1, 3, 3)     |          2304 |           2304 |    0.00000 |    0.00000 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.08024 |  0.00252 |    0.06383 |
# | 12 | module.model.6.3.weight  | (512, 256, 1, 1)   |        131072 |          65536 |    0.00000 |    0.00000 | 23.04688 | 50.00000 | 14.06250 |   50.00000 | 0.03595 | -0.00059 |    0.01904 |
# | 13 | module.model.7.0.weight  | (512, 1, 3, 3)     |          4608 |           4608 |    0.00000 |    0.00000 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.11005 | -0.00009 |    0.06821 |
# | 14 | module.model.7.3.weight  | (512, 512, 1, 1)   |        262144 |         131072 |    0.00000 |    0.00000 | 14.06250 | 50.00000 | 20.89844 |   50.00000 | 0.02978 | -0.00061 |    0.01637 |
# | 15 | module.model.8.0.weight  | (512, 1, 3, 3)     |          4608 |           4608 |    0.00000 |    0.00000 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.08257 |  0.00365 |    0.04913 |
# | 16 | module.model.8.3.weight  | (512, 512, 1, 1)   |        262144 |       k  131072 |    0.00000 |    0.00000 | 19.92188 | 50.00000 | 27.53906 |   50.00000 | 0.02887 | -0.00047 |    0.01543 |
# | 17 | module.model.9.0.weight  | (512, 1, 3, 3)     |          4608 |           4608 |    0.00000 |    0.00000 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.07575 |  0.00472 |    0.04201 |
# | 18 | module.model.9.3.weight  | (512, 512, 1, 1)   |        262144 |         131072 |    0.00000 |    0.00000 | 27.53906 | 50.00000 | 21.67969 |   50.00000 | 0.02959 | -0.00046 |    0.01581 |
# | 19 | module.model.10.0.weight | (512, 1, 3, 3)     |          4608 |           4608 |    0.00000 |    0.00000 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.07092 |  0.00016 |    0.04316 |
# | 20 | module.model.10.3.weight | (512, 512, 1, 1)   |        262144 |         131072 |    0.00000 |    0.00000 | 23.63281 | 50.00000 | 20.31250 |   50.00000 | 0.03127 | -0.00059 |    0.01786 |
# | 21 | module.model.11.0.weight | (512, 1, 3, 3)     |          4608 |           4608 |    0.00000 |    0.00000 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.05727 | -0.00522 |    0.04272 |
# | 22 | module.model.11.3.weight | (512, 512, 1, 1)   |        262144 |         131072 |    0.00000 |    0.00000 | 20.50781 | 50.00000 | 17.38281 |   50.00000 | 0.03274 | -0.00043 |    0.01948 |
# | 23 | module.model.12.0.weight | (512, 1, 3, 3)     |          4608 |           4608 |    0.00000 |    0.00000 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.04979 | -0.00142 |    0.03969 |
# | 24 | module.model.12.3.weight | (1024, 512, 1, 1)  |        524288 |         262144 |    0.00000 |    0.00000 | 12.89062 | 50.00000 | 37.79297 |   50.00000 | 0.02520 | -0.00108 |    0.01299 |
# | 25 | module.model.13.0.weight | (1024, 1, 3, 3)    |          9216 |           9216 |    0.00000 |    0.00000 |  0.00000 |  0.00000 |  0.00000 |    0.00000 | 0.02396 | -0.00950 |    0.01550 |
# | 26 | module.model.13.3.weight | (1024, 1024, 1, 1) |       1048576 |         524288 |    0.00000 |    0.00000 | 42.08984 | 50.00000 |  1.46484 |   50.00000 | 0.01811 | -0.00018 |    0.00973 |
# | 27 | module.fc.weight         | (1000, 1024)       |       1024000 |         409600 |    1.46484 |    0.00000 |  0.00000 |  0.00000 |  0.00000 |   60.00000 | 0.05075 |  0.00271 |    0.02733 |
# | 28 | Total sparsity:          | -                  |       4209088 |        2038208 |    0.00000 |    0.00000 |  0.00000 |  0.00000 |  0.00000 |   51.57602 | 0.00000 |  0.00000 |    0.00000 |
# +----+--------------------------+--------------------+---------------+----------------+------------+------------+----------+----------+----------+------------+---------+----------+------------+

version: 1
pruners:
  filter_pruner:
    class: 'L1RankedStructureParameterPruner_AGP'
    initial_sparsity : 0.15
    final_sparsity: 0.50
    group_type: Filters
    weights: [module.model.4.3.weight, module.model.5.3.weight, module.model.6.3.weight, module.model.7.3.weight,
              module.model.8.3.weight, module.model.9.3.weight, module.model.10.3.weight, module.model.11.3.weight, module.model.12.3.weight, module.model.13.3.weight]

  fc_pruner:
    class: 'AutomatedGradualPruner'
    initial_sparsity : 0.15
    final_sparsity: 0.60
    weights: [module.fc.weight]


  fine_pruner:
    class: 'AutomatedGradualPruner'
    initial_sparsity : 0.15
    final_sparsity: 0.50
    weights: [module.model.10.3.weight, module.model.11.3.weight,
              module.model.12.3.weight, module.model.13.3.weight]

extensions:
  net_thinner:
    class: 'FilterRemover'
    thinning_func_str: remove_filters
    arch: 'mobilenetv1'
    dataset: 'VWW dataset'
    input_shape: (1, 3, 224, 224)

lr_schedulers:
  pruning_lr:
    class: StepLR
    step_size: 30
    gamma: 0.10

policies:
  - pruner:
      instance_name : 'filter_pruner'
    starting_epoch: 0
    ending_epoch: 5 #50
    frequency: 2

  - pruner:
      instance_name : 'fc_pruner'
    starting_epoch: 0
    ending_epoch: 50
    frequency: 2

  - extension:
      instance_name: net_thinner
    epochs: [6] #[61]


  - lr_scheduler:
      instance_name: pruning_lr
    starting_epoch: 0
    ending_epoch: 100
    frequency: 1


